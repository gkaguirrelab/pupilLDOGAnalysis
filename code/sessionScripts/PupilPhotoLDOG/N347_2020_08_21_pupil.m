%% N347_2020_08_21_pupil
%
% The video analysis pre-processing pipeline for an LDOG session.
%
% To define mask bounds, use:
%{
	glintFrameMask = defineCropMask('pupil_L+S_01.mov','startFrame',10)
	pupilFrameMask = defineCropMask('pupil_L+S_01.mov','startFrame',10)
%}
% For the glint, put a tight box around the glint. For the pupil, define a
% mask area that safely contains the pupil at its most dilated.



reprocessFlag = false;


%% Session parameters

% Subject and session params.
pathParams.Subject = 'N347';
pathParams.Date = '2020-08-21';
pathParams.Session = '';

% The approach and protocol. These shouldn't change much
pathParams.Approach = 'OLApproach_TrialSequenceMR';
pathParams.Protocol = 'PupilPhotoLDOG';

% The names of the videos to process
videoNameStems = {...
    'pupil_LightFlux_1-6Hz_RightEyeStim_01',...
    'pupil_RodMel_1-6Hz_RightEyeStim_02',...
    'pupil_LplusS_1-6Hz_RightEyeStim_03',...
    'pupil_LightFlux_1-6Hz_LeftEyeStim_04',...
    'pupil_RodMel_1-6Hz_LeftEyeStim_05',...
    'pupil_LplusS_1-6Hz_LeftEyeStim_06',...
    'pupil_LightFlux_1-6Hz_RightEyeStim_07',...
    'pupil_RodMel_1-6Hz_RightEyeStim_08',...
    'pupil_LplusS_1-6Hz_RightEyeStim_09',...
    'pupil_LightFlux_1-6Hz_LeftEyeStim_10',...
    'pupil_RodMel_1-6Hz_LeftEyeStim_11',...
    'pupil_LplusS_1-6Hz_LeftEyeStim_12',...
    };

% Stimulus properties
sets = {[7 10],[2 5 8 11],[3 6 9]};
labels = {'pupil_LightFlux_1-6Hz_BothEyes','pupil_RodMel_1-6Hz_BothEyes',...
          'pupil_LplusS_1-6Hz_BothEyes'};
durations = [360,360,360,360,360,360];
freqs = [1/6,1/6,1/6,1/6,1/6,1/6];

% There is only one audio TTL pulse
checkCountTRs = [112 112 112 112 112 112 112 112 112 112 112 112];


% Mask bounds
glintFrameMaskSet = {...
    [219   112     5   295], ...
    [267   190   165   382], ...
    [259   204   183   388], ...
    [245   222   180   334], ...
    [333   415   106   184], ...
    [312   424   110   166], ...
    [213   368   211   229], ...
    [237   379   212   228], ...
    [213   362   227   235], ...
    [107   296   323   294], ...
    [84   174   351   423], ...
    [73   185   376   426]};
pupilFrameMaskSet = {...
    [177   139    14   269], ...
    [178   140   114   303], ...
    [161   143   123   322], ...
    [168   133    72   187], ...
    [281   329    15    21], ...
    [278   332    22    65], ...
    [147   264   114   146], ...
    [198   302   144   193], ...
    [136   265   141   171], ...
    [1    81   211   210], ...
    [41    66   229   346], ...
    [46   133   294   353]};

pupilCircleThreshSet = [0.025, 0.025, 0.025, 0.01, 0.015, 0.015, 0.045, 0.025, 0.025, 0.03, 0.025, 0.025];

pupilRangeSets = {[30 70], [30 70], [30 70], [30 70], [30 70], [30 80], [40 80], [30 70], [25 80], [40 80], [30 70], [40 80]};
candidateThetas = {[pi; 3*pi/4],[pi],[pi; 3*pi/4],[pi; pi/2],[pi],[pi/2],[pi],[3*pi/4],[3*pi/4],[pi],[pi],[5*pi/4; pi]};

ellipseEccenLBUB = {[0.2 0.6],[0.2 0.6],[0.2 0.6],[0.2 0.6],[0.2 0.6],[0.2 0.6],[0.2 0.6],[0.2 0.6],[0.2 0.6],[0.2 0.6],[0.2 0.6],[0.2 0.6],[0.2 0.6],[0.2 0.6],[0.2 0.6],[0.2 0.6]};

glintPatchRadius = [35,35,35,35,30,32,45,35,35,35,35,30];

minRadiusProportion = [0, 0, -0.3, 0, 0, 0, 0, 0, -0.2, 0, 0, 0];

cutErrorThreshold = [1,3,2,1,3,3,1,3,1,1,1,1];

ellipseAreaLB = [1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000];
ellipseAreaUP = [90000, 50000, 50000, 50000, 50000, 90000, 90000, 50000, 50000, 50000, 50000, 50000];
glintThreshold = [0.6, 0.4, 0.4, 0.4, 0.4, 0.4, 0.4, 0.2, 0.4, 0.4, 0.4, 0.4];

goodGlintFrame = [15, 9, 13, 5, 25, 9, 13, 179, 8, 9, 15, 3];
pupilGammaCorrection = [0.4,0.4,0.4,0.45,0.45,0.4,0.35,0.4,0.35,0.5,0.4,0.4];
motionCorrect = [true, false, false, false, false, false, false, false, false, true, false, false];

%% Loop through video name stems get each video and its corresponding masks
vids = [1,2,3,4,5,6,7,8,9,10,11,12];

if reprocessFlag
    for ii = vids
        pupilCircleThresh = pupilCircleThreshSet(ii);
        pupilRange = pupilRangeSets{ii};
        videoName = {videoNameStems{ii}};
        glintFrameMask = glintFrameMaskSet{ii};
        pupilFrameMask = pupilFrameMaskSet{ii};
        % Analysis parameters
        % To adjust these parameters for a given session, use the utility:
        %{
        estimatePipelineParamsGUI('','TOME')
        %}
        % And select one of the raw data .mov files.
        
        sessionKeyValues = {...
            'motionCorrect', motionCorrect(ii), ...
            'goodGlintFrame', goodGlintFrame(ii), ...
            'pupilGammaCorrection', pupilGammaCorrection(ii), ...
            'startFrame',1, ...
            'nFrames', Inf, ...
            'checkCountTRs',checkCountTRs(ii), ...
            'glintFrameMask',glintFrameMask,...
            'glintGammaCorrection',0.75,...
            'glintThreshold',glintThreshold(ii),...
            'pupilFrameMask',pupilFrameMask,...
            'pupilRange',pupilRange,...
            'pupilCircleThresh',pupilCircleThresh,...
            'glintPatchRadius',glintPatchRadius(ii),...
            'candidateThetas',candidateThetas{ii},...
            'cutErrorThreshold',cutErrorThreshold(ii),...
            'radiusDivisions',50,...
            'ellipseTransparentLB',[0,0,ellipseAreaLB(ii), ellipseEccenLBUB{ii}(1), 0],...
            'ellipseTransparentUB',[1280,720,ellipseAreaUP(ii),ellipseEccenLBUB{ii}(2), pi],...
            'minRadiusProportion', minRadiusProportion(ii),...
            };
        
        % Call the pre-processing pipeline
        pupilPipeline(pathParams,videoName,sessionKeyValues);
        
    end
end

%% Call the frequency fitting pipeline
fourierFitPipeline(pathParams,videoNameStems,sets,labels,durations,freqs);

