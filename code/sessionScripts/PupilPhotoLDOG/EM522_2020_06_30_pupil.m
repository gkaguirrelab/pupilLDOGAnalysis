%% EM522_2020_06_30_pupil
%
% The video analysis pre-processing pipeline for an LDOG session.
%
% To define mask bounds, use:
%{
	glintFrameMask = defineCropMask('pupil_L+S_01.mov','startFrame',10)
	pupilFrameMask = defineCropMask('pupil_L+S_01.mov','startFrame',10)
%}
% For the glint, put a tight box around the glint. For the pupil, define a
% mask area that safely contains the pupil at its most dilated.



reprocessFlag = false;


%% Session parameters

% Subject and session params.
pathParams.Subject = 'EM522';
pathParams.Date = '2020-06-30';
pathParams.Session = 'session_1';

% The approach and protocol. These shouldn't change much
pathParams.Approach = 'OLApproach_TrialSequenceMR';
pathParams.Protocol = 'PupilPhotoLDOG';

% The names of the videos to process
videoNameStems = {...
    'pupil_LightFlux_1-6Hz_RightEyeStim_01',...
    'pupil_RodMel_1-6Hz_RightEyeStim_02',...
    'pupil_LplusS_1-6Hz_RightEyeStim_03',...
    'pupil_LightFlux_1-6Hz_LeftEyeStim_04',...
    'pupil_RodMel_1-6Hz_LeftEyeStim_05',...
    'pupil_LplusS_1-6Hz_LeftEyeStim_06',...
    'pupil_LightFlux_1-6Hz_RightEyeStim_07',...
    'pupil_RodMel_1-6Hz_RightEyeStim_08',...
    'pupil_LplusS_1-6Hz_RightEyeStim_09',...
    'pupil_LightFlux_1-6Hz_LeftEyeStim_10',...
    'pupil_RodMel_1-6Hz_LeftEyeStim_11',...
    'pupil_LplusS_1-6Hz_LeftEyeStim_12',...
    };

% Stimulus properties
sets = {[1 4 7 10],[2 5 8 11],[3 9 12]};
labels = {'pupil_LightFlux_1-6Hz_BothEyes','pupil_RodMel_1-6Hz_BothEyes',...
          'pupil_LplusS_1-6Hz_BothEyes'};
durations = [360,360,360,360,360,360];
freqs = [1/6,1/6,1/6,1/6,1/6,1/6];

% There is only one audio TTL pulse
checkCountTRs = 112;

% Mask bounds
glintFrameMaskSet = {...
    [222   279   220   322], ... % Selected frame 1956
    [224   290   234   329], ... % 2519
    [210   290   248   327], ... % 10790
    [169   339   242   237], ... % 6825
    [107   261   218   232], ... % 10790
    [129   318   326   298], ... % 1919
    [174   283   283   334], ... % 971
    [163   303   295   318], ... % 3064
    [157   306   300   315], ... % 253
    [159   432   297   185], ... % 261
    [162   440   294   178], ... % 2470
    [143   412   286   178], ... % 1527
    };
pupilFrameMaskSet = {...
    [179   253   175   275], ...
    [191   259   176   284], ...
    [165   251   179   266], ...
    [117   113   127   206], ...
    [62    203   175   177], ...
    [86    244   252   264], ...
    [103   236   218   263], ...
    [100   230   200   216], ...
    [71    239   218   205], ...
    [80    307   193   122], ...
    [114   350   212   136], ...
    [95    340   223   130], ...
    };

pupilCircleThreshSet = [0.0200, 0.0160, 0.0250, 0.0450, 0.0310, 0.0530, 0.04, 0.0400, 0.0300, 0.0400, 0.0600, 0.0370];

pupilRangeSets = {[39 60], [41 50], [39 70], [47 60], [47 57], [55 67], [58 71], [42 60], [44 57], [63 80], [50 70], [44 54]};

candidateThetas = {[7*pi/4; pi/2],[5*pi/4],[5*pi/4],[3*pi/2; pi],[3*pi/2],[3*pi/2; pi],[5*pi/4],[5*pi/4],[pi],[5*pi/4],[pi; 5*pi/4],[pi; 5*pi/4; 3*pi/2]};

ellipseEccenLBUB = {[0.3 0.5],[0.3 0.5],[0.3 0.5],[0.3 0.5],[0.3 0.5],[0.3 0.5],[0.3 0.5],[0.3 0.5],[0.3 0.5],[0.3 0.5],[0.35 0.45],[0.4 0.5]};

glintPatchRadius = [30,20,20,45,20,20,20,20,20,20,20,30];

minRadiusProportion = [0, 0, 0, 0.5, 0, 0, 0, 0, 0, 0, 0.5, 0.5];

cutErrorThreshold = [1.5, 1.5, 1.5, 1.5, 1.5, 1.5, 1.5, 1.5, 1.5, 1.5, 2, 1.5];

ellipseAreaLB = [1000, 5000, 5000, 5000, 5000, 5000, 5000, 5000, 5000, 5000, 5000, 5000];
ellipseAreaUP = [15000, 15000, 15000, 50000, 15000, 15000, 15000, 15000, 15000, 50000, 15000, 50000];
glintThreshold = [0.3, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.3, 0.5, 0.3];
pupilGammaCorrection = [0.75,0.75,0.75,0.75,0.75,0.75,0.75,0.75,0.75,0.45,0.75,0.75];
%% Loop through video name stems get each video and its corresponding masks
numVids = [1,2,3,4,5,6,7,8,9,10,11,12]; % Stopped at 10 guess stage

if reprocessFlag
    for ii = numVids
        
        pupilCircleThresh = pupilCircleThreshSet(ii);
        pupilRange = pupilRangeSets{ii};
        videoName = {videoNameStems{ii}};
        glintFrameMask = glintFrameMaskSet{ii};
        pupilFrameMask = pupilFrameMaskSet{ii};
        % Analysis parameters
        % To adjust these parameters for a given session, use the utility:
        %{
        estimatePipelineParamsGUI('','TOME')
        %}
        % And select one of the raw data .mov files.
        
        sessionKeyValues = {...
            'startFrame',1, ...
            'nFrames', Inf, ...
            'checkCountTRs',checkCountTRs, ...
            'glintFrameMask',glintFrameMask,...
            'glintGammaCorrection',1.3,...
            'glintThreshold',glintThreshold(ii),...
            'pupilFrameMask',pupilFrameMask,...
            'pupilRange',pupilRange,...
            'pupilCircleThresh',pupilCircleThresh,...
            'pupilGammaCorrection', pupilGammaCorrection(ii), ...
            'glintPatchRadius',glintPatchRadius(ii),...
            'candidateThetas',candidateThetas{ii},...
            'cutErrorThreshold',cutErrorThreshold(ii),...
            'radiusDivisions',50,...
            'ellipseTransparentLB',[0,0,ellipseAreaLB(ii), ellipseEccenLBUB{ii}(1), 0],...
            'ellipseTransparentUB',[1280,720,ellipseAreaUP(ii),ellipseEccenLBUB{ii}(2), pi],...
            'minRadiusProportion', minRadiusProportion(ii),...
            };
        
        
        %     Call the pre-processing pipeline
        pupilPipeline(pathParams,videoName,sessionKeyValues);
        
    end
end

% % Call the frequency fitting pipeline
fourierFitPipeline(pathParams,videoNameStems,sets,labels,durations,freqs);

